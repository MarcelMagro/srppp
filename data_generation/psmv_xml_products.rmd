---
title: R code used to create a list of all products in the XML dumps of the PSMV
author: Johannes Ranke
date: 2023-11-16
output: html_document
---

```{r}
library(here)
library(dplyr, warn.conflicts = FALSE)
library(xml2)
library(stringr)
library(DT)
library(fgpsm)
```

We use all available zipped xml files to create a list
of tibbles with product attributes. We name the list with the
zip file publication dates. While looping over the dates,
we extract information on duplicate W-numbers, i.e. 
product sections in the xml file that share the same
W-Number.

```{r psmv-xml-products-list}
psmv_xml_products_list <- list()

duplicated_wNbrs <- data.frame(row.names = psmv_xml_dates)
system.time({
  for (i in psmv_xml_dates) {
    p <- psmv_xml_get_products(psmv_xml_get(i))
    dups <- attr(p, "duplicated_wNbrs")
    if (!is.null(dups)) {
      message("Duplicated W-Numbers for date ", i, ": ", paste(dups, collapse = ", "))
    }
    for (dup in dups) {
      duplicated_wNbrs[i, dup] <- TRUE
    }
    psmv_xml_products_list[[i]] <- p
  }
})

dup_w <- as.matrix(duplicated_wNbrs)
dup_w[is.na(dup_w)] <- FALSE
dup_w_list <- list()
for (w in colnames(dup_w)) {
  dup_w_list[[w]] <- rownames(dup_w)[which(dup_w[, w])] 
}

psmv_xml_product_wNbr_duplications <- dup_w_list

head(psmv_xml_product_wNbr_duplications)
```

There were `r length(psmv_xml_product_wNbr_duplications)` different duplicated 
W-Numbers in the XML files. 

Manual inspection of the first occurrence, the XML file for `2012-08-02` and looking 
for the product with W-Number 5945, exporting these two XML sections to two text
files and comparing the showed no difference, so this section was simply duplicated
by accident.

Manual inspection of the last occurrence, the XML file for `2016-12-01` and
looking for the product W-4009 (wNbr is 4009) shows that both product sections
with this W-Number contain the same indications with respect to cultures and
application rates, but one entry has no obligations in the indications, but
soldout and exhaustion dates, while the other has obligations in the
indications, but no such dates.

As only few products are affected, and only in some XML versions from the years
2012 and 2015, it seems to be reasonable to only use the second version in case
two product sections with the same W-Number are present.

At present, we just include all sections, but keep a record of the duplicated
products in a separate data object.

For further processing, we combine the list of product tibbles into one 
big tibble. 

```{r psmv-xml-products-all}
psmv_xml_products_all <- vctrs::vec_rbind(!!!psmv_xml_products_list,
  .names_to = "pub_date")
```

We extract all unique product names, after excluding comments
on the registration status that are sometimes stored in the name,
using the function `psmv_xml_clean_product_names`. 

```{r psmv-xml-product-names, dependson = "psmv-xml-product-list"}
psmv_xml_product_names <- psmv_xml_products_all |>
  mutate(cleaned = psmv_xml_clean_product_names(name)) |>
  group_by(wNbr, cleaned) |>
  summarise(first_date = min(pub_date), last_date = max(pub_date),
    .groups = "drop_last") |>
  mutate(wGrp = as.integer(gsub("-.*$", "", wNbr)), .before = 1) |>
  arrange(wGrp)

# The following calls to grep() were used to develop the function
# 'psmv_xml_clean_product_names'
#
# grep("\\(", psmv_xml_product_names$cleaned, value = TRUE)
# grep("\\[", psmv_xml_product_names$cleaned, value = TRUE)

print(psmv_xml_product_names)
```

The product names of some W-numbers have changed over time, resulting in
more names than unique W-numbers.

We get the first and last publication date for each W-number and include 
the information, how many times a W-number has occurred in more than one
product section.

```{r}
psmv_xml_product_wNbrs <- psmv_xml_products_all |>
  group_by(wNbr) |>
  summarise(first_date = min(pub_date), last_date = max(pub_date)) |>
  left_join(psmv_xml_products_all,
    by = c(wNbr = "wNbr", last_date = "pub_date")) |>
  select(wGrp, wNbr, id, name_last_date = name, first_date, last_date,
    terminationReason, soldoutDeadline, exhaustionDeadline) |>
  mutate(name_last_date_cleaned = psmv_xml_clean_product_names(name_last_date)) |>
  arrange(wGrp, wNbr) |>
  select(wNbr, id, name_last_date_cleaned, first_date, last_date,
    terminationReason, soldoutDeadline, exhaustionDeadline, name_last_date)

psmv_xml_product_wNbrs$duplications <- sapply(psmv_xml_product_wNbrs$wNbr, 
  function(w) length(dup_w_list[[w]]))

datatable(psmv_xml_product_wNbrs)
```

The following table shows, that there are also lots of products
with the same name that have different W-numbers, and often belong to different
W-number groups.

```{r duplicated-product-names}
dup_i <- duplicated(psmv_xml_product_names$cleaned)
duplicated_names <- unique(psmv_xml_product_names[dup_i, ]$cleaned)

prod_with_dup_names <- psmv_xml_product_names |>
  filter(cleaned %in% duplicated_names) |>
  arrange(cleaned, wGrp, wNbr)

datatable(prod_with_dup_names)
```

Finally, we save the table with W-Numbers, the list with duplicated W-Numbers 
and the table with product names to the data directory of the package.

```{r}
save(
  list = c(
    "psmv_xml_product_wNbrs",
    "psmv_xml_product_wNbr_duplications",
    "psmv_xml_product_names"
  ),
  file = here("data/psmv_xml_products.rda"),
  compress = "xz")
```
