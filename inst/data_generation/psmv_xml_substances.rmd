---
title: R code used to create a list of all substances in the XML dumps of the PSMV
author: Johannes Ranke
date: 2023-11-16
output: html_document
---

We load the 'here' package to make sure we are writing to the right directory
in the end. Also, we use the 'xml2' and the 'dplyr' packages, and some functions
and data from this package.

```{r}
library(here)
library(dplyr, warn.conflicts = FALSE)
library(xml2)
library(fgpsm)
```

Then we loop over all available zipped xml files, to create a list
of tibbles with primary keys, IUPAC names and descriptions.
We name the list with zip file publication dates.

```{r main-loop, cache = TRUE}
system.time({
  psmv_xml_substances_list <- lapply(psmv_xml_dates, function(i) {
    message("Extracting substances for ", i)
    psmv_xml_get_substances(psmv_xml_get(i))
  })
  names(psmv_xml_substances_list) <- names(psmv_xml_zip_files)
})
```

Then we combine the list into one big tibble and get the first and last
publication date for each substance. Our final table contains the iupac
names and the available descriptions in up to five languages from the last
publication date.

```{r}
psmv_xml_substances_all <- vctrs::vec_rbind(!!!psmv_xml_substances_list, .names_to = "pub_date")
psmv_xml_substances_range <- psmv_xml_substances_all |>
  group_by(pk) |>
  summarise(first_date = min(pub_date), last_date = max(pub_date))

psmv_xml_substances <- psmv_xml_substances_range |>
  left_join(psmv_xml_substances_all, by = c(pk = "pk", last_date = "pub_date"))

knitr::kable(head(psmv_xml_substances))
```
We can obtain a list of substances introduced after 2021-01-01:

```{r}
psmv_xml_substances |> 
  dplyr::filter(first_date >= "2021-01-01") |> 
  dplyr::select(pk, first_date, de) |> 
  dplyr::arrange(first_date)
```

Finally, we save the substance list to the data directory of the package.

```{r}
save(
  list = c(
    "psmv_xml_substances"
  ),
  file = here("data/psmv_xml_substances.rda"),
  compress = "xz")
```

