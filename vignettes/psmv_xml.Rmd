---
title: Building data objects from XML versions of the PSMV
author: Johannes Ranke
date: Last change 25 January 2024 (rebuilt `r Sys.Date()`)
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Building data objects from XML versions of the PSMV}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = TRUE, message = FALSE}
knitr::opts_chunk$set(tidy = FALSE, cache = FALSE)
options(knitr.kable.NA = '')
library(psmv)
library(dm)
```

## Background

 In the process of creating the first version of the PSMV SQL database,
some information got lost when exporting content from the Access
versions of the PSMV received from Agridea. Neither the W-Numbers
nor the XML ids were exported, instead of that a new `id_Uniqueproduct`
was created, which is not really unique.

Therefore, this package attempts to import relevant data from XML dumps
as published at the BLW website and collected at Agroscope into an R package,
while keeping referential integrity.

## Usage

When using this package on the Agroscope RStudio server, creating a set of
tables from a PSMV XML file is as easy as

```{r psmv-current, cache = TRUE}
time <- system.time(
  {
    psmv_current <- psmv_dm()
  }
)
```
But it takes a couple of seconds to complete.

```{r dependson = "psmv-current"}
print(time)
```

```{r dependson = "psmv-current"}
dm_draw(psmv_current)
```

```{r dependson = "psmv-current"}
dm_flatten_to_tbl(psmv_current, ingredients) |> 
  select(wNbr, name, substance_de, percent, g_per_L)
```
